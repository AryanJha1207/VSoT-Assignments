<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Weather Forecast - Live</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        /* [Keep all the CSS styles from previous version - they're perfect] */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Poppins', sans-serif;
        }

        body {
            background: linear-gradient(135deg, #6a11cb 0%, #2575fc 100%);
            color: #fff;
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            padding: 20px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 20px;
            backdrop-filter: blur(10px);
        }

        .logo {
            font-size: 28px;
            font-weight: 700;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .logo i {
            color: #ffd700;
        }

        .search-container {
            display: flex;
            gap: 10px;
            flex: 1;
            max-width: 500px;
        }

        #cityInput {
            flex: 1;
            padding: 12px 20px;
            border: none;
            border-radius: 50px;
            background: rgba(255, 255, 255, 0.9);
            font-size: 16px;
            outline: none;
        }

        #searchBtn {
            padding: 12px 25px;
            background: #ff9800;
            color: white;
            border: none;
            border-radius: 50px;
            cursor: pointer;
            font-weight: 600;
            transition: 0.3s;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        #searchBtn:hover {
            background: #ff7b00;
            transform: translateY(-2px);
        }

        #searchBtn.loading {
            background: #666;
            cursor: not-allowed;
        }

        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }

        .unit-toggle {
            display: flex;
            gap: 10px;
            background: rgba(255, 255, 255, 0.1);
            padding: 8px;
            border-radius: 50px;
        }

        .unit-btn {
            padding: 8px 20px;
            border: none;
            border-radius: 50px;
            background: transparent;
            color: white;
            cursor: pointer;
            font-weight: 500;
            transition: 0.3s;
        }

        .unit-btn.active {
            background: #ff9800;
        }

        .current-weather {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 20px;
            padding: 30px;
            margin-bottom: 30px;
            backdrop-filter: blur(10px);
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
        }

        .weather-main {
            display: flex;
            flex-direction: column;
            justify-content: center;
        }

        .temperature {
            font-size: 5rem;
            font-weight: 700;
            display: flex;
            align-items: flex-start;
            line-height: 1;
        }

        .location {
            font-size: 2rem;
            font-weight: 600;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .condition {
            font-size: 1.5rem;
            opacity: 0.9;
            margin-bottom: 20px;
        }

        .weather-icon {
            font-size: 80px;
            text-align: center;
            margin-bottom: 20px;
        }

        .weather-details {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 20px;
        }

        .detail-card {
            background: rgba(255, 255, 255, 0.1);
            padding: 20px;
            border-radius: 15px;
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .detail-icon {
            font-size: 24px;
            width: 50px;
            height: 50px;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .detail-info h3 {
            font-size: 14px;
            opacity: 0.8;
            margin-bottom: 5px;
        }

        .detail-info p {
            font-size: 20px;
            font-weight: 600;
        }

        .forecast {
            margin-bottom: 30px;
        }

        .section-title {
            font-size: 1.5rem;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .forecast-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 20px;
        }

        .forecast-card {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 15px;
            padding: 20px;
            text-align: center;
            backdrop-filter: blur(10px);
            transition: transform 0.3s;
        }

        .forecast-card:hover {
            transform: translateY(-5px);
        }

        .forecast-day {
            font-weight: 600;
            margin-bottom: 10px;
        }

        .forecast-icon {
            font-size: 40px;
            margin: 10px 0;
        }

        .forecast-temp {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin-top: 10px;
        }

        .high-temp {
            font-weight: 600;
        }

        .low-temp {
            opacity: 0.8;
        }

        .hourly-forecast {
            overflow-x: auto;
            padding: 20px 0;
            margin-bottom: 30px;
        }

        .hourly-container {
            display: flex;
            gap: 15px;
            min-width: min-content;
        }

        .hour-card {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 15px;
            padding: 15px;
            min-width: 100px;
            text-align: center;
            backdrop-filter: blur(10px);
        }

        .hour-time {
            font-weight: 600;
            margin-bottom: 10px;
        }

        .hour-temp {
            font-size: 1.2rem;
            font-weight: 600;
            margin-top: 10px;
        }

        .loading {
            text-align: center;
            padding: 40px;
            font-size: 1.2rem;
        }

        .error {
            background: rgba(255, 0, 0, 0.2);
            border: 1px solid rgba(255, 0, 0, 0.3);
            border-radius: 15px;
            padding: 20px;
            margin: 20px 0;
            text-align: center;
            display: none;
        }

        .error.show {
            display: block;
            animation: fadeIn 0.3s;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        .api-info {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 15px;
            padding: 15px;
            margin: 10px 0;
            font-size: 12px;
            text-align: center;
            display: none;
        }

        .api-info.show {
            display: block;
        }

        .debug-info {
            background: rgba(0, 0, 0, 0.2);
            border-radius: 10px;
            padding: 10px;
            margin-top: 10px;
            font-family: monospace;
            font-size: 11px;
            text-align: left;
            max-height: 100px;
            overflow-y: auto;
        }

        footer {
            text-align: center;
            padding: 20px;
            opacity: 0.7;
            font-size: 14px;
        }

        /* Responsive Design */
        @media (max-width: 768px) {
            header {
                flex-direction: column;
                gap: 20px;
            }
            
            .search-container {
                max-width: 100%;
            }
            
            .current-weather {
                grid-template-columns: 1fr;
            }
            
            .temperature {
                font-size: 4rem;
            }
            
            .forecast-cards {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        @media (max-width: 480px) {
            .forecast-cards {
                grid-template-columns: 1fr;
            }
            
            .weather-details {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <div class="logo">
                <i class="fas fa-cloud-sun"></i>
                <span>WeatherCast Live</span>
            </div>
            
            <div class="search-container">
                <input type="text" id="cityInput" placeholder="Search city..." value="London">
                <button id="searchBtn">
                    <i class="fas fa-search"></i> Search
                </button>
            </div>
            
            <div class="unit-toggle">
                <button class="unit-btn active" data-unit="metric">°C</button>
                <button class="unit-btn" data-unit="imperial">°F</button>
            </div>
        </header>

        <div class="api-info" id="apiInfo">
            <i class="fas fa-info-circle"></i> Using OpenWeatherMap API
            <div class="debug-info" id="debugInfo"></div>
        </div>

        <div class="error" id="errorMessage">
            <i class="fas fa-exclamation-triangle"></i>
            <span id="errorText">Error loading weather data</span>
            <div class="debug-info" id="errorDebug"></div>
        </div>

        <main id="weatherContent">
            <!-- Content will be loaded by JavaScript -->
            <div class="loading" id="loading">
                <i class="fas fa-spinner fa-spin"></i> Loading weather data...
            </div>
        </main>

        <footer>
            <p>Powered by OpenWeatherMap | Data updates every 10 minutes</p>
            <p>Last updated: <span id="lastUpdated">-</span></p>
        </footer>
    </div>

    <script>
        // ============================================
        // CONFIGURATION - SET YOUR API KEY HERE
        // ============================================
        const OPENWEATHER_API_KEY = 'YOUR_OPENWEATHER_API_KEY_HERE'; // ← Replace this with your actual key
        
        // Alternative APIs (fallback options)
        const WEATHERAPI_KEY = '76a6599668684104b1d65113262301'; // Optional: get from https://www.weatherapi.com/
        
        // ============================================
        // Weather Service Configuration
        // ============================================
        const config = {
            // Primary service (OpenWeatherMap)
            openWeather: {
                enabled: true,
                apiKey: OPENWEATHER_API_KEY,
                baseUrl: 'https://api.openweathermap.org/data/2.5',
                units: 'metric'
            },
            
            // Fallback service (if OpenWeather fails)
            weatherApi: {
                enabled: true, // Set to true if you have WeatherAPI key
                apiKey: 76a6599668684104b1d65113262301,
                baseUrl: 'https://api.weatherapi.com/v1'
            },
            
            // Demo mode (if no API keys work)
            demoMode: false,
            demoData: null
        };

        // ============================================
        // State Management
        // ============================================
        const state = {
            currentUnit: 'metric', // 'metric' for °C, 'imperial' for °F
            currentCity: 'London',
            isLoading: false,
            lastWeatherData: null,
            serviceInUse: 'openWeather',
            retryCount: 0,
            maxRetries: 3
        };

        // ============================================
        // DOM Elements
        // ============================================
        const elements = {
            cityInput: document.getElementById('cityInput'),
            searchBtn: document.getElementById('searchBtn'),
            unitBtns: document.querySelectorAll('.unit-btn'),
            weatherContent: document.getElementById('weatherContent'),
            loadingElement: document.getElementById('loading'),
            errorMessage: document.getElementById('errorMessage'),
            errorText: document.getElementById('errorText'),
            errorDebug: document.getElementById('errorDebug'),
            apiInfo: document.getElementById('apiInfo'),
            debugInfo: document.getElementById('debugInfo'),
            lastUpdated: document.getElementById('lastUpdated')
        };

        // ============================================
        // Weather Icon Mapping
        // ============================================
        const iconMap = {
            // OpenWeatherMap icons to Font Awesome
            '01d': 'fa-sun',           // clear sky day
            '01n': 'fa-moon',          // clear sky night
            '02d': 'fa-cloud-sun',     // few clouds day
            '02n': 'fa-cloud-moon',    // few clouds night
            '03d': 'fa-cloud',         // scattered clouds
            '03n': 'fa-cloud',
            '04d': 'fa-cloud',         // broken clouds
            '04n': 'fa-cloud',
            '09d': 'fa-cloud-rain',    // shower rain
            '09n': 'fa-cloud-rain',
            '10d': 'fa-cloud-sun-rain', // rain day
            '10n': 'fa-cloud-moon-rain', // rain night
            '11d': 'fa-bolt',          // thunderstorm
            '11n': 'fa-bolt',
            '13d': 'fa-snowflake',     // snow
            '13n': 'fa-snowflake',
            '50d': 'fa-smog',          // mist
            '50n': 'fa-smog',
            
            // Default fallback
            'default': 'fa-cloud'
        };

        // ============================================
        // DEMO DATA (for testing without API)
        // ============================================
        const demoWeatherData = {
            current: {
                city: "London",
                country: "UK",
                temp: 15,
                feels_like: 14,
                condition: "Cloudy with light rain",
                icon: "10d",
                wind_speed: 12,
                humidity: 78,
                pressure: 1015,
                visibility: 10,
                sunrise: Date.now() - 4 * 60 * 60 * 1000,
                sunset: Date.now() + 4 * 60 * 60 * 1000
            },
            forecast: [
                { day: "Mon", high: 16, low: 12, condition: "Light rain", icon: "10d" },
                { day: "Tue", high: 17, low: 13, condition: "Partly cloudy", icon: "02d" },
                { day: "Wed", high: 18, low: 14, condition: "Sunny", icon: "01d" },
                { day: "Thu", high: 16, low: 13, condition: "Cloudy", icon: "03d" },
                { day: "Fri", high: 15, low: 12, condition: "Rain", icon: "09d" }
            ],
            hourly: [
                { time: "Now", temp: 15, icon: "10d" },
                { time: "1 PM", temp: 16, icon: "10d" },
                { time: "2 PM", temp: 16, icon: "10d" },
                { time: "3 PM", temp: 15, icon: "03d" },
                { time: "4 PM", temp: 15, icon: "03d" },
                { time: "5 PM", temp: 14, icon: "03d" },
                { time: "6 PM", temp: 13, icon: "03n" },
                { time: "7 PM", temp: 13, icon: "02n" }
            ]
        };

        // ============================================
        // INITIALIZATION
        // ============================================
        document.addEventListener('DOMContentLoaded', () => {
            console.log('Weather App Initializing...');
            console.log('OpenWeather API Key present:', !!config.openWeather.apiKey && config.openWeather.apiKey !== '76a6599668684104b1d65113262301');
            console.log('WeatherAPI Key present:', !!config.weatherApi.apiKey);
            
            setupEventListeners();
            validateApiKeys();
            loadInitialWeather();
        });

        // ============================================
        // API KEY VALIDATION
        // ============================================
        function validateApiKeys() {
            const owValid = config.openWeather.apiKey && 
                           config.openWeather.apiKey !== '76a6599668684104b1d65113262301' &&
                           config.openWeather.apiKey.length > 20;
            
            const waValid = config.weatherApi.apiKey && 
                           config.weatherApi.apiKey.length > 10;
            
            console.log('API Key Status:', {
                openWeather: owValid ? 'Valid' : 'Invalid/Missing',
                weatherApi: waValid ? 'Valid' : 'Invalid/Missing'
            });
            
            if (!owValid && !waValid) {
                console.warn('No valid API keys found. Enabling demo mode.');
                config.demoMode = true;
                showApiInfo('Demo Mode Active - Using sample data');
            } else {
                config.demoMode = false;
                showApiInfo(`Using ${owValid ? 'OpenWeatherMap' : 'WeatherAPI'} Service`);
            }
        }

        // ============================================
        // EVENT LISTENERS
        // ============================================
        function setupEventListeners() {
            // Search button
            elements.searchBtn.addEventListener('click', handleSearch);
            
            // Enter key in input
            elements.cityInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') handleSearch();
            });
            
            // Unit toggle buttons
            elements.unitBtns.forEach(btn => {
                btn.addEventListener('click', () => {
                    elements.unitBtns.forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');
                    state.currentUnit = btn.dataset.unit;
                    if (state.lastWeatherData) {
                        updateDisplay(state.lastWeatherData);
                    }
                });
            });
            
            // Input focus
            elements.cityInput.addEventListener('focus', () => {
                hideError();
            });
        }

        // ============================================
        // SEARCH HANDLER
        // ============================================
        async function handleSearch() {
            const city = elements.cityInput.value.trim();
            if (!city) {
                showError('Please enter a city name');
                return;
            }
            
            state.currentCity = city;
            state.retryCount = 0;
            await loadWeatherData(city);
        }

        // ============================================
        // MAIN WEATHER DATA LOADER
        // ============================================
        async function loadWeatherData(city) {
            showLoading();
            hideError();
            
            try {
                let weatherData;
                
                // Try OpenWeatherMap first if enabled and has valid key
                if (config.openWeather.enabled && config.openWeather.apiKey && 
                    config.openWeather.apiKey !== '76a6599668684104b1d65113262301') {
                    
                    console.log('Trying OpenWeatherMap API...');
                    weatherData = await fetchOpenWeatherData(city);
                    
                    if (weatherData) {
                        state.serviceInUse = 'openWeather';
                        state.lastWeatherData = weatherData;
                        updateDisplay(weatherData);
                        updateTime();
                        showApiInfo('OpenWeatherMap API Active');
                        return;
                    }
                }
                
                // Try WeatherAPI as fallback
                if (config.weatherApi.enabled && config.weatherApi.apiKey) {
                    console.log('Trying WeatherAPI...');
                    weatherData = await fetchWeatherApiData(city);
                    
                    if (weatherData) {
                        state.serviceInUse = 'weatherApi';
                        state.lastWeatherData = weatherData;
                        updateDisplay(weatherData);
                        updateTime();
                        showApiInfo('WeatherAPI Active');
                        return;
                    }
                }
                
                // If all APIs fail, use demo data
                if (config.demoMode) {
                    console.log('Using demo data...');
                    await new Promise(resolve => setTimeout(resolve, 1000)); // Simulate loading
                    
                    // Create demo data for searched city
                    const demoData = JSON.parse(JSON.stringify(demoWeatherData));
                    demoData.current.city = city.split(',')[0].trim();
                    
                    state.serviceInUse = 'demo';
                    state.lastWeatherData = demoData;
                    updateDisplay(demoData);
                    updateTime();
                    showApiInfo('Demo Mode - Using sample data');
                    showWarning('Demo Mode: Showing sample data. Add a real API key for live weather.');
                    return;
                }
                
                // If we get here, all services failed
                throw new Error('All weather services failed. Please try again later.');
                
            } catch (error) {
                console.error('Error loading weather data:', error);
                
                // Retry logic
                if (state.retryCount < state.maxRetries) {
                    state.retryCount++;
                    console.log(`Retrying... (${state.retryCount}/${state.maxRetries})`);
                    await new Promise(resolve => setTimeout(resolve, 1000 * state.retryCount));
                    return loadWeatherData(city);
                }
                
                showError(`Failed to load weather for "${city}". ${error.message}`);
            } finally {
                hideLoading();
            }
        }

        // ============================================
        // OPENWEATHERMAP API CALL
        // ============================================
        async function fetchOpenWeatherData(city) {
            try {
                const units = state.currentUnit;
                const apiKey = config.openWeather.apiKey;
                
                // Build URL with error handling
                const currentUrl = `${config.openWeather.baseUrl}/weather?q=${encodeURIComponent(city)}&appid=${apiKey}&units=${units}`;
                const forecastUrl = `${config.openWeather.baseUrl}/forecast?q=${encodeURIComponent(city)}&appid=${apiKey}&units=${units}`;
                
                console.log('Fetching from:', currentUrl.replace(apiKey, 'API_KEY_REDACTED'));
                
                // Fetch current weather
                const currentResponse = await fetch(currentUrl);
                
                if (!currentResponse.ok) {
                    const errorData = await currentResponse.json().catch(() => ({}));
                    throw new Error(`OpenWeatherMap: ${errorData.message || `HTTP ${currentResponse.status}`}`);
                }
                
                const currentData = await currentResponse.json();
                
                // Fetch forecast
                const forecastResponse = await fetch(forecastUrl);
                if (!forecastResponse.ok) {
                    // If forecast fails, we can still use current data
                    console.warn('Forecast failed, using only current data');
                }
                const forecastData = await forecastResponse.json().catch(() => null);
                
                // Process the data
                return processOpenWeatherData(currentData, forecastData);
                
            } catch (error) {
                console.error('OpenWeatherMap API error:', error);
                return null;
            }
        }

        // ============================================
        // DATA PROCESSING
        // ============================================
        function processOpenWeatherData(currentData, forecastData) {
            // Process current weather
            const weatherData = {
                current: {
                    city: currentData.name,
                    country: currentData.sys?.country || '',
                    temp: Math.round(currentData.main.temp),
                    feels_like: Math.round(currentData.main.feels_like),
                    condition: currentData.weather[0]?.description || 'N/A',
                    icon: currentData.weather[0]?.icon || 'default',
                    wind_speed: Math.round(currentData.wind.speed * 3.6), // m/s to km/h
                    humidity: currentData.main.humidity,
                    pressure: currentData.main.pressure,
                    visibility: (currentData.visibility / 1000).toFixed(1),
                    sunrise: currentData.sys?.sunrise * 1000,
                    sunset: currentData.sys?.sunset * 1000
                },
                forecast: [],
                hourly: []
            };

            // Process forecast if available
            if (forecastData && forecastData.list) {
                // Group by day for 5-day forecast
                const dailyMap = new Map();
                
                forecastData.list.forEach(item => {
                    const date = new Date(item.dt * 1000);
                    const dayKey = date.toLocaleDateString('en-US', { weekday: 'short' });
                    
                    if (!dailyMap.has(dayKey) || dailyMap.get(dayKey).dt < item.dt) {
                        dailyMap.set(dayKey, {
                            day: dayKey,
                            high: Math.round(item.main.temp_max),
                            low: Math.round(item.main.temp_min),
                            condition: item.weather[0]?.description || '',
                            icon: item.weather[0]?.icon || 'default'
                        });
                    } else {
                        const existing = dailyMap.get(dayKey);
                        existing.high = Math.max(existing.high, Math.round(item.main.temp_max));
                        existing.low = Math.min(existing.low, Math.round(item.main.temp_min));
                    }
                    
                    // Add to hourly forecast (next 24 hours)
                    const now = new Date();
                    const hoursDiff = (date - now) / (1000 * 60 * 60);
                    if (hoursDiff >= 0 && hoursDiff <= 24 && weatherData.hourly.length < 8) {
                        const hourLabel = date.getHours() === 0 ? '12 AM' : 
                                        date.getHours() === 12 ? '12 PM' :
                                        date.getHours() > 12 ? `${date.getHours() - 12} PM` : 
                                        `${date.getHours()} AM`;
                        
                        weatherData.hourly.push({
                            time: hoursDiff < 1 ? 'Now' : hourLabel,
                            temp: Math.round(item.main.temp),
                            icon: item.weather[0]?.icon || 'default'
                        });
                    }
                });
                
                // Convert map to array and take first 5 days
                weatherData.forecast = Array.from(dailyMap.values()).slice(0, 5);
            } else {
                // Create dummy forecast if API failed
                for (let i = 1; i <= 5; i++) {
                    const date = new Date();
                    date.setDate(date.getDate() + i);
                    weatherData.forecast.push({
                        day: date.toLocaleDateString('en-US', { weekday: 'short' }),
                        high: weatherData.current.temp + Math.floor(Math.random() * 3),
                        low: weatherData.current.temp - Math.floor(Math.random() * 3),
                        condition: 'Partly cloudy',
                        icon: '02d'
                    });
                }
            }
            
            return weatherData;
        }

        // ============================================
        // WEATHERAPI.COM FALLBACK (Optional)
        // ============================================
        async function fetchWeatherApiData(city) {
            if (!config.weatherApi.apiKey) return null;
            
            try {
                const url = `${config.weatherApi.baseUrl}/forecast.json?key=${config.weatherApi.apiKey}&q=${encodeURIComponent(city)}&days=5`;
                const response = await fetch(url);
                
                if (!response.ok) return null;
                
                const data = await response.json();
                // Process WeatherAPI data format here
                // This is a placeholder - you'd need to implement the processing
                
                return null; // Remove this when implementing
                
            } catch (error) {
                console.error('WeatherAPI error:', error);
                return null;
            }
        }

        // ============================================
        // INITIAL WEATHER LOAD
        // ============================================
        async function loadInitialWeather() {
            // Try to get user's location
            if (navigator.geolocation && !config.demoMode) {
                navigator.geolocation.getCurrentPosition(
                    async (position) => {
                        try {
                            // Use reverse geocoding to get city from coordinates
                            const { latitude, longitude } = position.coords;
                            const url = `${config.openWeather.baseUrl}/weather?lat=${latitude}&lon=${longitude}&appid=${config.openWeather.apiKey}&units=metric`;
                            
                            const response = await fetch(url);
                            if (response.ok) {
                                const data = await response.json();
                                elements.cityInput.value = data.name;
                                state.currentCity = data.name;
                            }
                        } catch (error) {
                            console.log('Geolocation weather failed, using default');
                        }
                        
                        await loadWeatherData(state.currentCity);
                    },
                    (error) => {
                        console.log('Geolocation failed:', error);
                        loadWeatherData(state.currentCity);
                    },
                    { timeout: 5000 }
                );
            } else {
                await loadWeatherData(state.currentCity);
            }
        }

        // ============================================
        // UI UPDATE FUNCTIONS
        // ============================================
        function updateDisplay(weatherData) {
            const { current, forecast, hourly } = weatherData;
            
            const html = `
                <section class="current-weather">
                    <div class="weather-main">
                        <div class="location">
                            <i class="fas fa-map-marker-alt"></i>
                            <span id="currentCity">${current.city}${current.country ? `, ${current.country}` : ''}</span>
                        </div>
                        <div class="temperature">
                            <span id="currentTemp">${current.temp}</span>
                            <span class="unit">${state.currentUnit === 'metric' ? '°C' : '°F'}</span>
                        </div>
                        <div class="condition" id="currentCondition">${capitalizeFirst(current.condition)}</div>
                        <div class="weather-icon">
                            <i class="fas ${iconMap[current.icon] || iconMap.default}" id="weatherIcon"></i>
                        </div>
                    </div>
                    
                    <div class="weather-details">
                        <div class="detail-card">
                            <div class="detail-icon">
                                <i class="fas fa-wind"></i>
                            </div>
                            <div class="detail-info">
                                <h3>Wind Speed</h3>
                                <p id="windSpeed">${current.wind_speed} km/h</p>
                            </div>
                        </div>
                        
                        <div class="detail-card">
                            <div class="detail-icon">
                                <i class="fas fa-tint"></i>
                            </div>
                            <div class="detail-info">
                                <h3>Humidity</h3>
                                <p id="humidity">${current.humidity}%</p>
                            </div>
                        </div>
                        
                        <div class="detail-card">
                            <div class="detail-icon">
                                <i class="fas fa-temperature-high"></i>
                            </div>
                            <div class="detail-info">
                                <h3>Feels Like</h3>
                                <p id="feelsLike">${current.feels_like}°${state.currentUnit === 'metric' ? 'C' : 'F'}</p>
                            </div>
                        </div>
                        
                        <div class="detail-card">
                            <div class="detail-icon">
                                <i class="fas fa-compress-alt"></i>
                            </div>
                            <div class="detail-info">
                                <h3>Pressure</h3>
                                <p id="pressure">${current.pressure} hPa</p>
                            </div>
                        </div>
                    </div>
                </section>

                <section class="forecast">
                    <h2 class="section-title">
                        <i class="fas fa-calendar-alt"></i>
                        5-Day Forecast
                    </h2>
                    <div class="forecast-cards" id="forecastContainer">
                        ${forecast.map(day => `
                            <div class="forecast-card">
                                <div class="forecast-day">${day.day}</div>
                                <div class="forecast-icon">
                                    <i class="fas ${iconMap[day.icon] || iconMap.default}"></i>
                                </div>
                                <div class="forecast-condition">${capitalizeFirst(day.condition)}</div>
                                <div class="forecast-temp">
                                    <span class="high-temp">${day.high}°</span>
                                    <span class="low-temp">${day.low}°</span>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                </section>

                <section class="hourly-forecast">
                    <h2 class="section-title">
                        <i class="fas fa-clock"></i>
                        Next 24 Hours
                    </h2>
                    <div class="hourly-container" id="hourlyContainer">
                        ${hourly.map(hour => `
                            <div class="hour-card">
                                <div class="hour-time">${hour.time}</div>
                                <div class="hour-icon">
                                    <i class="fas ${iconMap[hour.icon] || iconMap.default}"></i>
                                </div>
                                <div class="hour-temp">${hour.temp}°</div>
                            </div>
                        `).join('')}
                    </div>
                </section>
            `;
            
            elements.weatherContent.innerHTML = html;
        }

        // ============================================
        // HELPER FUNCTIONS
        // ============================================
        function capitalizeFirst(str) {
            return str.split(' ').map(word => 
                word.charAt(0).toUpperCase() + word.slice(1)
            ).join(' ');
        }

        function updateTime() {
            const now = new Date();
            elements.lastUpdated.textContent = now.toLocaleString();
        }

        function showLoading() {
            state.isLoading = true;
            elements.loadingElement.style.display = 'block';
            elements.searchBtn.classList.add('loading');
            elements.searchBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Loading';
            elements.searchBtn.disabled = true;
        }

        function hideLoading() {
            state.isLoading = false;
            elements.loadingElement.style.display = 'none';
            elements.searchBtn.classList.remove('loading');
            elements.searchBtn.innerHTML = '<i class="fas fa-search"></i> Search';
            elements.searchBtn.disabled = false;
        }

        function showError(message, debugInfo = '') {
            elements.errorText.textContent = message;
            elements.errorDebug.textContent = debugInfo || `Service: ${state.serviceInUse} | City: ${state.currentCity}`;
            elements.errorMessage.classList.add('show');
        }

        function showWarning(message) {
            // Create a warning toast
            const warning = document.createElement('div');
            warning.className = 'error';
            warning.style.background = 'rgba(255, 193, 7, 0.2)';
            warning.style.borderColor = 'rgba(255, 193, 7, 0.3)';
            warning.innerHTML = `<i class="fas fa-exclamation-circle"></i> ${message}`;
            warning.style.marginTop = '10px';
            warning.style.marginBottom = '10px';
            
            elements.errorMessage.parentNode.insertBefore(warning, elements.errorMessage.nextSibling);
            
            setTimeout(() => {
                warning.remove();
            }, 5000);
        }

        function hideError() {
            elements.errorMessage.classList.remove('show');
        }

        function showApiInfo(message) {
            elements.apiInfo.innerHTML = `<i class="fas fa-info-circle"></i> ${message}`;
            elements.apiInfo.classList.add('show');
            
            // Add debug info
            elements.debugInfo.textContent = `City: ${state.currentCity} | Unit: ${state.currentUnit} | Service: ${state.serviceInUse}`;
        }

        // ============================================
        // AUTO-REFRESH
        // ============================================
        setInterval(() => {
            if (state.currentCity && !state.isLoading) {
                loadWeatherData(state.currentCity);
            }
        }, 600000); // 10 minutes

        // ============================================
        // TEST FUNCTION - For debugging
        // ============================================
        window.testAPI = function() {
            const testUrl = `https://api.openweathermap.org/data/2.5/weather?q=London&appid=${config.openWeather.apiKey}&units=metric`;
            
            console.log('Testing API URL:', testUrl.replace(config.openWeather.apiKey, 'API_KEY_REDACTED'));
            
            fetch(testUrl)
                .then(response => {
                    console.log('Response Status:', response.status, response.statusText);
                    return response.json();
                })
                .then(data => {
                    console.log('API Response:', data);
                    if (data.cod === 200) {
                        alert('API Key is working! ✅\nReceived data for: ' + data.name);
                    } else {
                        alert('API Error: ' + data.message);
                    }
                })
                .catch(error => {
                    console.error('API Test Failed:', error);
                    alert('API Test Failed: ' + error.message);
                });
        };

        // Add test button for debugging
        const testBtn = document.createElement('button');
        testBtn.innerHTML = '<i class="fas fa-bug"></i> Test API';
        testBtn.style.position = 'fixed';
        testBtn.style.bottom = '10px';
        testBtn.style.right = '10px';
        testBtn.style.padding = '8px 12px';
        testBtn.style.background = '#333';
        testBtn.style.color = 'white';
        testBtn.style.border = 'none';
        testBtn.style.borderRadius = '5px';
        testBtn.style.cursor = 'pointer';
        testBtn.style.fontSize = '12px';
        testBtn.style.zIndex = '1000';
        testBtn.onclick = window.testAPI;
        document.body.appendChild(testBtn);
    </script>
</body>
</html>